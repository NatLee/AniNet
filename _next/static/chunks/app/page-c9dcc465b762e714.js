(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[931],{9863:function(t,e,a){Promise.resolve().then(a.bind(a,4427))},4427:function(t,e,a){"use strict";a.d(e,{default:function(){return u}});var n=a(7437),i=a(2265);let o=t=>{let e=t.startsWith("/")?t.slice(1):t;return"".concat("/image-annotation","/").concat(e)},l=t=>t.startsWith("http://")||t.startsWith("https://")||t.startsWith("//"),r=t=>l(t)?t:o(t);var s=t=>{let{image:e,imageMetadata:a,boundingBoxes:o,onAddBoundingBox:l,onUpdateBoundingBox:s,onDeleteBoundingBox:d}=t,c=(0,i.useRef)(null),[h,u]=(0,i.useState)(null),[g,m]=(0,i.useState)(null),x=(0,i.useCallback)(t=>{if(!a)return{x:0,y:0,width:0,height:0};let{displaySize:e,originalSize:n}=a,i=e.width/n.width,o=e.height/n.height,l=t.x*i,r=t.y*o,s=t.width*i,d=t.height*o;return{x:Math.max(0,Math.min(l,e.width-s)),y:Math.max(0,Math.min(r,e.height-d)),width:s,height:d}},[a]),p=(0,i.useCallback)(t=>{if(!a)return{x:0,y:0,width:0,height:0};let{displaySize:e,originalSize:n}=a,i=n.width/e.width,o=n.height/e.height;return{x:t.x*i,y:t.y*o,width:t.width*i,height:t.height*o}},[a]),b=(0,i.useCallback)(t=>{if(!a)return t;let{originalSize:e}=a,{x:n,y:i,width:o,height:l}=t;return o=Math.max(10,o),l=Math.max(10,l),o=Math.min(o,e.width),l=Math.min(l,e.height),{x:Math.round(n=Math.max(0,Math.min(n,e.width-o))),y:Math.round(i=Math.max(0,Math.min(i,e.height-l))),width:Math.round(o),height:Math.round(l)}},[a]),w=(t,e)=>{t.stopPropagation(),u(e);let a=o.find(t=>t.id===e);a&&m({type:"move",boxId:e,startX:t.clientX,startY:t.clientY,originalBox:a})},f=(t,e,a)=>{t.stopPropagation(),u(e);let n=o.find(t=>t.id===e);n&&m({type:"resize",boxId:e,handle:a,startX:t.clientX,startY:t.clientY,originalBox:n})};return((0,i.useEffect)(()=>{let t=t=>{"Delete"===t.key&&h&&(d(h),u(null))};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[h,d]),e)?(0,n.jsxs)("div",{ref:c,className:"image-canvas relative no-select",style:{width:null==a?void 0:a.displaySize.width,height:null==a?void 0:a.displaySize.height,display:"inline-block",position:"relative",margin:0,padding:0},onMouseDown:t=>{t.target===t.currentTarget&&u(null)},onMouseMove:t=>{if(g&&c.current){if("move"===g.type&&g.originalBox){let e=t.clientX-g.startX,a=t.clientY-g.startY,n=p({x:e,y:a,width:0,height:0}).x,i=p({x:e,y:a,width:0,height:0}).y,o=b({x:g.originalBox.x+n,y:g.originalBox.y+i,width:g.originalBox.width,height:g.originalBox.height});s(g.boxId,o)}else if("resize"===g.type&&g.originalBox){let e=t.clientX-g.startX,a=t.clientY-g.startY,{handle:n,originalBox:i}=g,{x:o,y:l,width:r,height:d}=x(i);n&&(n.includes("right")&&(r+=e),n.includes("left")&&(o+=e,r-=e),n.includes("bottom")&&(d+=a),n.includes("top")&&(l+=a,d-=a));let c=b(p({x:o,y:l,width:r,height:d}));s(g.boxId,c)}}},onMouseUp:t=>{m(null)},children:[(0,n.jsx)("img",{src:e,alt:"Annotation target",style:{width:"".concat(null==a?void 0:a.displaySize.width,"px"),height:"".concat(null==a?void 0:a.displaySize.height,"px"),display:"block",margin:0,padding:0,border:"none",pointerEvents:"none"},draggable:!1,onError:t=>{console.error("Failed to load image:",e),t.currentTarget.src=r("placeholder-error.png")}}),o.map(t=>{let e=x(t),a=h===t.id;return(0,n.jsxs)("div",{className:"bounding-box-original absolute ".concat(a?"selected":""),style:{left:e.x,top:e.y,width:e.width,height:e.height,cursor:"move",border:"3px solid #00ff00",backgroundColor:"rgba(0, 255, 0, 0.2)",boxShadow:"0 0 5px rgba(0, 0, 0, 0.5)",boxSizing:"border-box"},onMouseDown:e=>w(e,t.id),onClick:e=>{e.stopPropagation(),u(t.id)},children:[(0,n.jsx)("div",{className:"box-label-inside",children:t.label}),(0,n.jsxs)("div",{className:"box-info-inside",children:[Math.round(t.width),"\xd7",Math.round(t.height)]}),(0,n.jsxs)("div",{className:"box-position-inside",children:["(",Math.round(t.x),", ",Math.round(t.y),")"]}),a&&[{position:"top-left",cursor:"nwse-resize"},{position:"top-right",cursor:"nesw-resize"},{position:"bottom-left",cursor:"nesw-resize"},{position:"bottom-right",cursor:"nwse-resize"}].map(e=>{let{position:a,cursor:i}=e;return(0,n.jsx)("div",{className:"resize-handle-ui",style:{cursor:i,position:"absolute",top:a.includes("top")?-4:void 0,bottom:a.includes("bottom")?-4:void 0,left:a.includes("left")?-4:void 0,right:a.includes("right")?-4:void 0},onMouseDown:e=>f(e,t.id,a)},a)})]},t.id)})]}):(0,n.jsx)("div",{className:"flex items-center justify-center h-96 bg-gray-100 border-2 border-dashed border-gray-300 rounded-lg",children:(0,n.jsxs)("div",{className:"text-center",children:[(0,n.jsx)("p",{className:"text-gray-500 text-lg",children:"No image loaded"}),(0,n.jsx)("p",{className:"text-gray-400 text-sm mt-2",children:"Load an image to start annotating"})]})})};let d=t=>{let e=c(),a=e.annotation_records.findIndex(e=>e.image_url===t.image_url);-1!==a?e.annotation_records[a]=t:e.annotation_records.push(t),e.total_images=e.annotation_records.length,e.total_annotations=e.annotation_records.reduce((t,e)=>t+e.bounding_boxes.length,0),e.last_updated=new Date().toISOString(),localStorage.setItem("annotation_data",JSON.stringify(e))},c=()=>{let t=localStorage.getItem("annotation_data");return t?JSON.parse(t):{annotation_records:[],total_images:0,total_annotations:0,last_updated:new Date().toISOString()}},h=()=>{let[t,e]=(0,i.useState)(null),[a,n]=(0,i.useState)(null),[o,l]=(0,i.useState)([]),[s,c]=(0,i.useState)(null),[h,u]=(0,i.useState)(null),g=(0,i.useCallback)(t=>{if(!t||!t.naturalWidth)return null;let e=window.innerHeight-70-20,a=window.innerWidth-20,n=t.naturalWidth/t.naturalHeight,i=a,o=i/n;return o>e&&(i=(o=e)*n),{originalSize:{width:t.naturalWidth,height:t.naturalHeight},displaySize:{width:Math.floor(i),height:Math.floor(o)},scaleFactor:i/t.naturalWidth}},[]),m=(0,i.useCallback)(t=>{n(t);let a=r(t);e(a),l([]);let i=new Image;i.onload=()=>{let t=g(i);if(!t)return;c(t);let e=.25*Math.min(i.naturalWidth,i.naturalHeight),a=(i.naturalWidth-e)/2,n=(i.naturalHeight-e)/2;l([{id:"box_".concat(Date.now(),"_").concat(Math.random().toString(36).substr(2,9)),x:a,y:n,width:e,height:e,label:"anime_face"}])},i.onerror=()=>{alert("Failed to load image. Please check the URL or try a different image."),e(null),n(null)},i.src=a},[g]);(0,i.useEffect)(()=>{let e;let a=()=>{clearTimeout(e),e=setTimeout(()=>{if(!t)return;let e=new Image;e.onload=()=>{let t=g(e);t&&c(t)},e.src=t},100)};return window.addEventListener("resize",a),()=>{clearTimeout(e),window.removeEventListener("resize",a)}},[t,g]);let x=(0,i.useCallback)(()=>{var t;if(!a||!s)return;if(0===o.length){alert("Please create at least one bounding box before submitting!");return}let i=localStorage.getItem("userName")||"anonymous";if((null===(t=JSON.parse(localStorage.getItem("annotation_data")||'{"annotation_records":[]}').annotation_records)||void 0===t?void 0:t.some(t=>t.image_url===a))&&!confirm("This image has already been annotated. Do you want to overwrite the previous annotation?"))return;d({session_id:"session_".concat(Date.now()),image_url:a,original_size:s.originalSize,display_size:s.displaySize,scale_factor:s.scaleFactor,annotator:i,timestamp:new Date().toISOString(),bounding_boxes:o});let r=JSON.parse(localStorage.getItem("annotation_data")||"{}");alert("Annotation submitted successfully!\nTotal annotated images: ".concat(r.total_images,"\nTotal annotations: ").concat(r.total_annotations)),l([]),e(null),n(null)},[a,s,o]),p=(0,i.useCallback)(t=>{let e;if(!s)return;if(t)e=t;else{let t=s.originalSize.width,a=s.originalSize.height,n=.25*Math.min(t,a),i=(t-n)/2,l=(a-n)/2;if(o.length>0){let t=o[o.length-1];i=t.x+20,l=t.y+20}e={x:i,y:l,width:n,height:n,label:"anime_face"}}let a={...e,id:"box_".concat(Date.now(),"_").concat(Math.random().toString(36).substr(2,9))};l(t=>[...t,a])},[s,o]),b=(0,i.useCallback)((t,e)=>{l(a=>a.map(a=>a.id===t?{...a,...e}:a))},[]);return{currentImage:t,boundingBoxes:o,imageMetadata:s,loadImage:m,addBoundingBox:p,updateBoundingBox:b,deleteBoundingBox:(0,i.useCallback)(t=>{l(e=>e.filter(e=>e.id!==t))},[]),deleteLastBoundingBox:(0,i.useCallback)(()=>{l(t=>t.slice(0,-1))},[]),submitAnnotation:x,clearAnnotations:(0,i.useCallback)(()=>{l([])},[])}};var u=()=>{let{currentImage:t,boundingBoxes:e,imageMetadata:a,loadImage:o,addBoundingBox:l,updateBoundingBox:r,deleteBoundingBox:d,deleteLastBoundingBox:c,submitAnnotation:u,clearAnnotations:g}=h(),[m,x]=(0,i.useState)(""),[p,b]=(0,i.useState)(!1),[w,f]=(0,i.useState)(!1),[y,v]=(0,i.useState)([]);(0,i.useEffect)(()=>{let t=localStorage.getItem("userName");t?x(t):alert("請輸入你的名字！")},[]),(0,i.useEffect)(()=>{(async()=>{try{let t=await fetch("https://api.waifu.im/search"),e=await t.json();e.images&&e.images[0]&&o(e.images[0].url)}catch(t){console.error("Failed to fetch initial image:",t)}})()},[o]);let _=(0,i.useCallback)(async()=>{u();try{let t=await fetch("https://api.waifu.im/search"),e=await t.json();e.images&&e.images[0]&&o(e.images[0].url)}catch(t){console.error("Failed to fetch next image:",t),window.location.reload()}},[u,o]);(0,i.useEffect)(()=>{let t=t=>{"d"===t.key&&f(t=>!t)};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[]);let[S,j]=(0,i.useState)(0);return(0,i.useEffect)(()=>{let t=()=>{let t=localStorage.getItem("annotation_data");return t&&JSON.parse(t).total_images||0};j(t());let e=setInterval(()=>{j(t())},1e3);return()=>clearInterval(e)},[]),(0,n.jsxs)("div",{id:"wrapper",children:[(0,n.jsxs)("div",{id:"main",children:[(0,n.jsx)("div",{id:"image-annotation",className:"panel ".concat(p?"":"active"),children:(0,n.jsx)("div",{className:"image-container",children:t&&a?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(s,{image:t,imageMetadata:a,boundingBoxes:e,onAddBoundingBox:l,onUpdateBoundingBox:r,onDeleteBoundingBox:d}),w&&(0,n.jsx)("div",{className:"grid-overlay",children:[...Array(10)].map((t,e)=>(0,n.jsxs)(i.Fragment,{children:[(0,n.jsx)("div",{style:{position:"absolute",top:0,left:"".concat(10*e,"%"),width:"1px",height:"100%",backgroundColor:"rgba(255, 0, 0, 0.5)",pointerEvents:"none"}}),(0,n.jsx)("div",{style:{position:"absolute",top:"".concat(10*e,"%"),left:0,width:"100%",height:"1px",backgroundColor:"rgba(255, 0, 0, 0.5)",pointerEvents:"none"}})]},e))})]}):(0,n.jsx)("div",{style:{color:"#fff",padding:"2em"},children:"Loading image..."})})}),(0,n.jsxs)("div",{id:"rank-container",className:"panel ".concat(p?"active":""),children:[(0,n.jsx)("h1",{children:"Rank"}),(0,n.jsx)("div",{className:"tbl-header",children:(0,n.jsx)("table",{cellPadding:"0",cellSpacing:"0",border:0,children:(0,n.jsx)("thead",{children:(0,n.jsxs)("tr",{children:[(0,n.jsx)("th",{children:"Name"}),(0,n.jsx)("th",{children:"Count"})]})})})}),(0,n.jsx)("div",{className:"tbl-content",children:(0,n.jsx)("table",{cellPadding:"0",cellSpacing:"0",border:0,children:(0,n.jsx)("tbody",{id:"rank-body",children:y.map((t,e)=>{let[a,i]=t;return(0,n.jsxs)("tr",{children:[(0,n.jsx)("td",{children:a}),(0,n.jsx)("td",{children:i})]},e)})})})}),(0,n.jsx)("button",{id:"back-to-game",className:"button",onClick:()=>b(!1),children:"Back"})]})]}),(0,n.jsxs)("div",{id:"toolbar",children:[(0,n.jsxs)("div",{className:"left-controls",children:[(0,n.jsx)("input",{type:"text",id:"userName",placeholder:"Enter your name",value:m,onChange:t=>{let e=t.target.value;x(e),localStorage.setItem("userName",e)},required:!0}),(0,n.jsx)("div",{id:"image-dimensions",children:a&&(0,n.jsxs)(n.Fragment,{children:["Original: ",a.originalSize.width,"\xd7",a.originalSize.height," | Display: ",Math.round(a.displaySize.width),"\xd7",Math.round(a.displaySize.height)," | Scale: ",(100*a.scaleFactor).toFixed(2),"%"]})})]}),(0,n.jsxs)("div",{className:"center-controls",children:[(0,n.jsx)("button",{id:"add",className:"button",onClick:()=>l(),children:"Add Box"}),(0,n.jsx)("button",{id:"del",className:"button",onClick:c,children:"Delete Box"}),(0,n.jsx)("button",{id:"submit",className:"button",onClick:_,children:"Submit Annotation"}),(0,n.jsx)("button",{id:"export-all",className:"button",onClick:()=>{var t,e;let a=localStorage.getItem("annotation_data");if(!a){alert("No annotation data found to export!");return}let n=JSON.parse(a);if(0===n.annotation_records.length){alert("No annotation data found to export!");return}let i=new Blob([JSON.stringify({export_info:{export_date:new Date().toISOString(),total_images:n.total_images,total_annotations:n.total_annotations,data_range:{first_annotation:null===(t=n.annotation_records[0])||void 0===t?void 0:t.timestamp,last_annotation:null===(e=n.annotation_records[n.annotation_records.length-1])||void 0===e?void 0:e.timestamp}},annotation_records:n.annotation_records},null,2)],{type:"application/json"}),o=URL.createObjectURL(i),l=document.createElement("a");l.href=o,l.download="all_annotations_".concat(new Date().toISOString().split("T")[0],".json"),document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(o),alert("Exported ".concat(n.total_images," images with ").concat(n.total_annotations," annotations!"))},children:"Export All Data"}),(0,n.jsx)("button",{id:"clear-all",className:"button",onClick:()=>{confirm("Are you sure you want to delete all annotation data? This cannot be undone.")&&(localStorage.removeItem("annotation_data"),alert("All annotation data cleared!"))},children:"Clear All Data"})]}),(0,n.jsxs)("div",{className:"right-controls",children:[(0,n.jsx)("button",{id:"rank",className:"button",onClick:()=>{let t=localStorage.getItem("annotation_data");if(!t){v([]),b(!0);return}try{let e=JSON.parse(t),a={};e.annotation_records.forEach(t=>{let e=t.annotated_by||"Unknown";a[e]||(a[e]=0),a[e]+=1});let n=Object.entries(a);n.sort((t,e)=>e[1]-t[1]),v(n),b(!0)}catch(t){console.error("Failed to parse annotation data for ranking:",t),v([]),b(!0)}},children:"Rank"}),(0,n.jsx)("button",{id:"details",className:"button",onClick:()=>{alert("框頭，整顆頭！YEE！")},children:"Details"})]}),(0,n.jsx)("h1",{id:"count",className:"count-header",children:S})]})]})}}},function(t){t.O(0,[971,117,744],function(){return t(t.s=9863)}),_N_E=t.O()}]);