(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[931],{9863:function(t,e,n){Promise.resolve().then(n.bind(n,4427))},257:function(t,e,n){"use strict";var a,i;t.exports=(null==(a=n.g.process)?void 0:a.env)&&"object"==typeof(null==(i=n.g.process)?void 0:i.env)?n.g.process:n(4227)},4227:function(t){!function(){var e={229:function(t){var e,n,a,i=t.exports={};function o(){throw Error("setTimeout has not been defined")}function r(){throw Error("clearTimeout has not been defined")}function l(t){if(e===setTimeout)return setTimeout(t,0);if((e===o||!e)&&setTimeout)return e=setTimeout,setTimeout(t,0);try{return e(t,0)}catch(n){try{return e.call(null,t,0)}catch(n){return e.call(this,t,0)}}}!function(){try{e="function"==typeof setTimeout?setTimeout:o}catch(t){e=o}try{n="function"==typeof clearTimeout?clearTimeout:r}catch(t){n=r}}();var s=[],d=!1,c=-1;function u(){d&&a&&(d=!1,a.length?s=a.concat(s):c=-1,s.length&&h())}function h(){if(!d){var t=l(u);d=!0;for(var e=s.length;e;){for(a=s,s=[];++c<e;)a&&a[c].run();c=-1,e=s.length}a=null,d=!1,function(t){if(n===clearTimeout)return clearTimeout(t);if((n===r||!n)&&clearTimeout)return n=clearTimeout,clearTimeout(t);try{n(t)}catch(e){try{return n.call(null,t)}catch(e){return n.call(this,t)}}}(t)}}function g(t,e){this.fun=t,this.array=e}function m(){}i.nextTick=function(t){var e=Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)e[n-1]=arguments[n];s.push(new g(t,e)),1!==s.length||d||l(h)},g.prototype.run=function(){this.fun.apply(null,this.array)},i.title="browser",i.browser=!0,i.env={},i.argv=[],i.version="",i.versions={},i.on=m,i.addListener=m,i.once=m,i.off=m,i.removeListener=m,i.removeAllListeners=m,i.emit=m,i.prependListener=m,i.prependOnceListener=m,i.listeners=function(t){return[]},i.binding=function(t){throw Error("process.binding is not supported")},i.cwd=function(){return"/"},i.chdir=function(t){throw Error("process.chdir is not supported")},i.umask=function(){return 0}}},n={};function a(t){var i=n[t];if(void 0!==i)return i.exports;var o=n[t]={exports:{}},r=!0;try{e[t](o,o.exports,a),r=!1}finally{r&&delete n[t]}return o.exports}a.ab="//";var i=a(229);t.exports=i}()},4427:function(t,e,n){"use strict";n.d(e,{default:function(){return g}});var a=n(7437),i=n(2265);let o=n(257).env.NEXT_PUBLIC_BASE_PATH||"",r=t=>{let e=t.startsWith("/")?t.slice(1):t;return"".concat(o,"/").concat(e)},l=t=>t.startsWith("http://")||t.startsWith("https://")||t.startsWith("//"),s=t=>l(t)?t:r(t);var d=t=>{let{image:e,imageMetadata:n,boundingBoxes:o,onAddBoundingBox:r,onUpdateBoundingBox:l,onDeleteBoundingBox:d}=t,c=(0,i.useRef)(null),[u,h]=(0,i.useState)(null),[g,m]=(0,i.useState)(null),x=(0,i.useCallback)(t=>{if(!n)return{x:0,y:0,width:0,height:0};let{displaySize:e,originalSize:a}=n,i=e.width/a.width,o=e.height/a.height,r=t.x*i,l=t.y*o,s=t.width*i,d=t.height*o;return{x:Math.max(0,Math.min(r,e.width-s)),y:Math.max(0,Math.min(l,e.height-d)),width:s,height:d}},[n]),p=(0,i.useCallback)(t=>{if(!n)return{x:0,y:0,width:0,height:0};let{displaySize:e,originalSize:a}=n,i=a.width/e.width,o=a.height/e.height;return{x:t.x*i,y:t.y*o,width:t.width*i,height:t.height*o}},[n]),f=(0,i.useCallback)(t=>{if(!n)return t;let{originalSize:e}=n,{x:a,y:i,width:o,height:r}=t;return o=Math.max(10,o),r=Math.max(10,r),o=Math.min(o,e.width),r=Math.min(r,e.height),{x:Math.round(a=Math.max(0,Math.min(a,e.width-o))),y:Math.round(i=Math.max(0,Math.min(i,e.height-r))),width:Math.round(o),height:Math.round(r)}},[n]),b=(t,e)=>{t.stopPropagation(),h(e);let n=o.find(t=>t.id===e);n&&m({type:"move",boxId:e,startX:t.clientX,startY:t.clientY,originalBox:n})},w=(t,e,n)=>{t.stopPropagation(),h(e);let a=o.find(t=>t.id===e);a&&m({type:"resize",boxId:e,handle:n,startX:t.clientX,startY:t.clientY,originalBox:a})};return((0,i.useEffect)(()=>{let t=t=>{"Delete"===t.key&&u&&(d(u),h(null))};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[u,d]),e)?(0,a.jsxs)("div",{ref:c,className:"image-canvas relative no-select",style:{width:null==n?void 0:n.displaySize.width,height:null==n?void 0:n.displaySize.height,display:"inline-block",position:"relative",margin:0,padding:0},onMouseDown:t=>{t.target===t.currentTarget&&h(null)},onMouseMove:t=>{if(g&&c.current){if("move"===g.type&&g.originalBox){let e=t.clientX-g.startX,n=t.clientY-g.startY,a=p({x:e,y:n,width:0,height:0}).x,i=p({x:e,y:n,width:0,height:0}).y,o=f({x:g.originalBox.x+a,y:g.originalBox.y+i,width:g.originalBox.width,height:g.originalBox.height});l(g.boxId,o)}else if("resize"===g.type&&g.originalBox){let e=t.clientX-g.startX,n=t.clientY-g.startY,{handle:a,originalBox:i}=g,{x:o,y:r,width:s,height:d}=x(i);a&&(a.includes("right")&&(s+=e),a.includes("left")&&(o+=e,s-=e),a.includes("bottom")&&(d+=n),a.includes("top")&&(r+=n,d-=n));let c=f(p({x:o,y:r,width:s,height:d}));l(g.boxId,c)}}},onMouseUp:t=>{m(null)},children:[(0,a.jsx)("img",{src:e,alt:"Annotation target",style:{width:"".concat(null==n?void 0:n.displaySize.width,"px"),height:"".concat(null==n?void 0:n.displaySize.height,"px"),display:"block",margin:0,padding:0,border:"none",pointerEvents:"none"},draggable:!1,onError:t=>{console.error("Failed to load image:",e),t.currentTarget.src=s("placeholder-error.png")}}),o.map(t=>{let e=x(t),n=u===t.id;return(0,a.jsxs)("div",{className:"bounding-box-original absolute ".concat(n?"selected":""),style:{left:e.x,top:e.y,width:e.width,height:e.height,cursor:"move",border:"3px solid #00ff00",backgroundColor:"rgba(0, 255, 0, 0.2)",boxShadow:"0 0 5px rgba(0, 0, 0, 0.5)",boxSizing:"border-box"},onMouseDown:e=>b(e,t.id),onClick:e=>{e.stopPropagation(),h(t.id)},children:[(0,a.jsx)("div",{className:"box-label-inside",children:t.label}),(0,a.jsxs)("div",{className:"box-info-inside",children:[Math.round(t.width),"\xd7",Math.round(t.height)]}),(0,a.jsxs)("div",{className:"box-position-inside",children:["(",Math.round(t.x),", ",Math.round(t.y),")"]}),n&&[{position:"top-left",cursor:"nwse-resize"},{position:"top-right",cursor:"nesw-resize"},{position:"bottom-left",cursor:"nesw-resize"},{position:"bottom-right",cursor:"nwse-resize"}].map(e=>{let{position:n,cursor:i}=e;return(0,a.jsx)("div",{className:"resize-handle-ui",style:{cursor:i,position:"absolute",top:n.includes("top")?-4:void 0,bottom:n.includes("bottom")?-4:void 0,left:n.includes("left")?-4:void 0,right:n.includes("right")?-4:void 0},onMouseDown:e=>w(e,t.id,n)},n)})]},t.id)})]}):(0,a.jsx)("div",{className:"flex items-center justify-center h-96 bg-gray-100 border-2 border-dashed border-gray-300 rounded-lg",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("p",{className:"text-gray-500 text-lg",children:"No image loaded"}),(0,a.jsx)("p",{className:"text-gray-400 text-sm mt-2",children:"Load an image to start annotating"})]})})};let c=t=>{let e=u(),n=e.annotation_records.findIndex(e=>e.image_url===t.image_url);-1!==n?e.annotation_records[n]=t:e.annotation_records.push(t),e.total_images=e.annotation_records.length,e.total_annotations=e.annotation_records.reduce((t,e)=>t+e.bounding_boxes.length,0),e.last_updated=new Date().toISOString(),localStorage.setItem("annotation_data",JSON.stringify(e))},u=()=>{let t=localStorage.getItem("annotation_data");return t?JSON.parse(t):{annotation_records:[],total_images:0,total_annotations:0,last_updated:new Date().toISOString()}},h=()=>{let[t,e]=(0,i.useState)(null),[n,a]=(0,i.useState)(null),[o,r]=(0,i.useState)([]),[l,d]=(0,i.useState)(null),[u,h]=(0,i.useState)(null),g=(0,i.useCallback)(t=>{if(!t||!t.naturalWidth)return null;let e=window.innerHeight-70-20,n=window.innerWidth-20,a=t.naturalWidth/t.naturalHeight,i=n,o=i/a;return o>e&&(i=(o=e)*a),{originalSize:{width:t.naturalWidth,height:t.naturalHeight},displaySize:{width:Math.floor(i),height:Math.floor(o)},scaleFactor:i/t.naturalWidth}},[]),m=(0,i.useCallback)(t=>{a(t);let n=s(t);e(n),r([]);let i=new Image;i.onload=()=>{let t=g(i);if(!t)return;d(t);let e=.25*Math.min(i.naturalWidth,i.naturalHeight),n=(i.naturalWidth-e)/2,a=(i.naturalHeight-e)/2;r([{id:"box_".concat(Date.now(),"_").concat(Math.random().toString(36).substr(2,9)),x:n,y:a,width:e,height:e,label:"anime_face"}])},i.onerror=()=>{alert("Failed to load image. Please check the URL or try a different image."),e(null),a(null)},i.src=n},[g]);(0,i.useEffect)(()=>{let e;let n=()=>{clearTimeout(e),e=setTimeout(()=>{if(!t)return;let e=new Image;e.onload=()=>{let t=g(e);t&&d(t)},e.src=t},100)};return window.addEventListener("resize",n),()=>{clearTimeout(e),window.removeEventListener("resize",n)}},[t,g]);let x=(0,i.useCallback)(()=>{var t;if(!n||!l)return;if(0===o.length){alert("Please create at least one bounding box before submitting!");return}let i=localStorage.getItem("userName")||"anonymous";if((null===(t=JSON.parse(localStorage.getItem("annotation_data")||'{"annotation_records":[]}').annotation_records)||void 0===t?void 0:t.some(t=>t.image_url===n))&&!confirm("This image has already been annotated. Do you want to overwrite the previous annotation?"))return;c({session_id:"session_".concat(Date.now()),image_url:n,original_size:l.originalSize,display_size:l.displaySize,scale_factor:l.scaleFactor,annotator:i,timestamp:new Date().toISOString(),bounding_boxes:o});let s=JSON.parse(localStorage.getItem("annotation_data")||"{}");alert("Annotation submitted successfully!\nTotal annotated images: ".concat(s.total_images,"\nTotal annotations: ").concat(s.total_annotations)),r([]),e(null),a(null)},[n,l,o]),p=(0,i.useCallback)(t=>{let e;if(!l)return;if(t)e=t;else{let t=l.originalSize.width,n=l.originalSize.height,a=.25*Math.min(t,n),i=(t-a)/2,r=(n-a)/2;if(o.length>0){let t=o[o.length-1];i=t.x+20,r=t.y+20}e={x:i,y:r,width:a,height:a,label:"anime_face"}}let n={...e,id:"box_".concat(Date.now(),"_").concat(Math.random().toString(36).substr(2,9))};r(t=>[...t,n])},[l,o]),f=(0,i.useCallback)((t,e)=>{r(n=>n.map(n=>n.id===t?{...n,...e}:n))},[]);return{currentImage:t,boundingBoxes:o,imageMetadata:l,loadImage:m,addBoundingBox:p,updateBoundingBox:f,deleteBoundingBox:(0,i.useCallback)(t=>{r(e=>e.filter(e=>e.id!==t))},[]),deleteLastBoundingBox:(0,i.useCallback)(()=>{r(t=>t.slice(0,-1))},[]),submitAnnotation:x,clearAnnotations:(0,i.useCallback)(()=>{r([])},[])}};var g=()=>{let{currentImage:t,boundingBoxes:e,imageMetadata:n,loadImage:o,addBoundingBox:r,updateBoundingBox:l,deleteBoundingBox:s,deleteLastBoundingBox:c,submitAnnotation:u,clearAnnotations:g}=h(),[m,x]=(0,i.useState)(""),[p,f]=(0,i.useState)(!1),[b,w]=(0,i.useState)(!1),[v,y]=(0,i.useState)([]);(0,i.useEffect)(()=>{let t=localStorage.getItem("userName");t?x(t):alert("請輸入你的名字！")},[]),(0,i.useEffect)(()=>{(async()=>{try{let t=await fetch("https://api.waifu.im/search"),e=await t.json();e.images&&e.images[0]&&o(e.images[0].url)}catch(t){console.error("Failed to fetch initial image:",t)}})()},[o]);let _=(0,i.useCallback)(async()=>{u();try{let t=await fetch("https://api.waifu.im/search"),e=await t.json();e.images&&e.images[0]&&o(e.images[0].url)}catch(t){console.error("Failed to fetch next image:",t),window.location.reload()}},[u,o]);(0,i.useEffect)(()=>{let t=t=>{"d"===t.key&&w(t=>!t)};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[]);let[S,j]=(0,i.useState)(0);return(0,i.useEffect)(()=>{let t=()=>{let t=localStorage.getItem("annotation_data");return t&&JSON.parse(t).total_images||0};j(t());let e=setInterval(()=>{j(t())},1e3);return()=>clearInterval(e)},[]),(0,a.jsxs)("div",{id:"wrapper",children:[(0,a.jsxs)("div",{id:"main",children:[(0,a.jsx)("div",{id:"image-annotation",className:"panel ".concat(p?"":"active"),children:(0,a.jsx)("div",{className:"image-container",children:t&&n?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(d,{image:t,imageMetadata:n,boundingBoxes:e,onAddBoundingBox:r,onUpdateBoundingBox:l,onDeleteBoundingBox:s}),b&&(0,a.jsx)("div",{className:"grid-overlay",children:[...Array(10)].map((t,e)=>(0,a.jsxs)(i.Fragment,{children:[(0,a.jsx)("div",{style:{position:"absolute",top:0,left:"".concat(10*e,"%"),width:"1px",height:"100%",backgroundColor:"rgba(255, 0, 0, 0.5)",pointerEvents:"none"}}),(0,a.jsx)("div",{style:{position:"absolute",top:"".concat(10*e,"%"),left:0,width:"100%",height:"1px",backgroundColor:"rgba(255, 0, 0, 0.5)",pointerEvents:"none"}})]},e))})]}):(0,a.jsx)("div",{style:{color:"#fff",padding:"2em"},children:"Loading image..."})})}),(0,a.jsxs)("div",{id:"rank-container",className:"panel ".concat(p?"active":""),children:[(0,a.jsx)("h1",{children:"Rank"}),(0,a.jsx)("div",{className:"tbl-header",children:(0,a.jsx)("table",{cellPadding:"0",cellSpacing:"0",border:0,children:(0,a.jsx)("thead",{children:(0,a.jsxs)("tr",{children:[(0,a.jsx)("th",{children:"Name"}),(0,a.jsx)("th",{children:"Count"})]})})})}),(0,a.jsx)("div",{className:"tbl-content",children:(0,a.jsx)("table",{cellPadding:"0",cellSpacing:"0",border:0,children:(0,a.jsx)("tbody",{id:"rank-body",children:v.map((t,e)=>{let[n,i]=t;return(0,a.jsxs)("tr",{children:[(0,a.jsx)("td",{children:n}),(0,a.jsx)("td",{children:i})]},e)})})})}),(0,a.jsx)("button",{id:"back-to-game",className:"button",onClick:()=>f(!1),children:"Back"})]})]}),(0,a.jsxs)("div",{id:"toolbar",children:[(0,a.jsxs)("div",{className:"left-controls",children:[(0,a.jsx)("input",{type:"text",id:"userName",placeholder:"Enter your name",value:m,onChange:t=>{let e=t.target.value;x(e),localStorage.setItem("userName",e)},required:!0}),(0,a.jsx)("div",{id:"image-dimensions",children:n&&(0,a.jsxs)(a.Fragment,{children:["Original: ",n.originalSize.width,"\xd7",n.originalSize.height," | Display: ",Math.round(n.displaySize.width),"\xd7",Math.round(n.displaySize.height)," | Scale: ",(100*n.scaleFactor).toFixed(2),"%"]})})]}),(0,a.jsxs)("div",{className:"center-controls",children:[(0,a.jsx)("button",{id:"add",className:"button",onClick:()=>r(),children:"Add Box"}),(0,a.jsx)("button",{id:"del",className:"button",onClick:c,children:"Delete Box"}),(0,a.jsx)("button",{id:"submit",className:"button",onClick:_,children:"Submit Annotation"}),(0,a.jsx)("button",{id:"export-all",className:"button",onClick:()=>{var t,e;let n=localStorage.getItem("annotation_data");if(!n){alert("No annotation data found to export!");return}let a=JSON.parse(n);if(0===a.annotation_records.length){alert("No annotation data found to export!");return}let i=new Blob([JSON.stringify({export_info:{export_date:new Date().toISOString(),total_images:a.total_images,total_annotations:a.total_annotations,data_range:{first_annotation:null===(t=a.annotation_records[0])||void 0===t?void 0:t.timestamp,last_annotation:null===(e=a.annotation_records[a.annotation_records.length-1])||void 0===e?void 0:e.timestamp}},annotation_records:a.annotation_records},null,2)],{type:"application/json"}),o=URL.createObjectURL(i),r=document.createElement("a");r.href=o,r.download="all_annotations_".concat(new Date().toISOString().split("T")[0],".json"),document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(o),alert("Exported ".concat(a.total_images," images with ").concat(a.total_annotations," annotations!"))},children:"Export All Data"}),(0,a.jsx)("button",{id:"clear-all",className:"button",onClick:()=>{confirm("Are you sure you want to delete all annotation data? This cannot be undone.")&&(localStorage.removeItem("annotation_data"),alert("All annotation data cleared!"))},children:"Clear All Data"})]}),(0,a.jsxs)("div",{className:"right-controls",children:[(0,a.jsx)("button",{id:"rank",className:"button",onClick:()=>{let t=JSON.parse(localStorage.getItem("rankData")||"{}"),e=[];for(let n in t)e.push([n,t[n]]);e.sort((t,e)=>e[1]-t[1]),y(e),f(!0)},children:"Rank"}),(0,a.jsx)("button",{id:"details",className:"button",onClick:()=>{alert("框頭，整顆頭！YEE！")},children:"Details"})]}),(0,a.jsx)("h1",{id:"count",className:"count-header",children:S})]})]})}}},function(t){t.O(0,[971,117,744],function(){return t(t.s=9863)}),_N_E=t.O()}]);